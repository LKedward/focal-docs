
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://lkedward.github.io/focal-docs/events/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.1, mkdocs-material-7.1.9">
    
    
      
        <title>Events and synchronisation - Focal Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.ca7ac06f.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.f1a3b89f.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#events-and-synchronisation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Focal Documentation" class="md-header__button md-logo" aria-label="Focal Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 17H7V7h10m4 4V9h-2V7a2 2 0 0 0-2-2h-2V3h-2v2h-2V3H9v2H7c-1.11 0-2 .89-2 2v2H3v2h2v2H3v2h2v2a2 2 0 0 0 2 2h2v2h2v-2h2v2h2v-2h2a2 2 0 0 0 2-2v-2h2v-2h-2v-2m-6 2h-2v-2h2m2-2H9v6h6V9z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Focal Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Events and synchronisation
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/LKedward/focal" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Focal Documentation" class="md-nav__button md-logo" aria-label="Focal Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 17H7V7h10m4 4V9h-2V7a2 2 0 0 0-2-2h-2V3h-2v2h-2V3H9v2H7c-1.11 0-2 .89-2 2v2H3v2h2v2H3v2h2v2a2 2 0 0 0 2 2h2v2h2v-2h2v2h2v-2h2a2 2 0 0 0 2-2v-2h2v-2h-2v-2m-6 2h-2v-2h2m2-2H9v6h6V9z"/></svg>

    </a>
    Focal Documentation
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/LKedward/focal" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        Getting started
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Getting started" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../build/" class="md-nav__link">
        Building the Focal Library
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../linking/" class="md-nav__link">
        Linking Focal Programs
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../quickstart/" class="md-nav__link">
        Quickstart Guide
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      <label class="md-nav__link" for="__nav_3">
        User guide
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="User guide" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          User guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../setup/" class="md-nav__link">
        Setup
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../memory/" class="md-nav__link">
        Managing memory
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../kernels/" class="md-nav__link">
        Working with kernels
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Events and synchronisation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Events and synchronisation
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-event-objects" class="md-nav__link">
    1. Event objects
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-host-synchronisation" class="md-nav__link">
    2. Host synchronisation
  </a>
  
    <nav class="md-nav" aria-label="2. Host synchronisation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-waiting-for-events" class="md-nav__link">
    2.1 Waiting for events
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-dependencies-and-barriers" class="md-nav__link">
    3. Dependencies and barriers
  </a>
  
    <nav class="md-nav" aria-label="3. Dependencies and barriers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-event-dependencies" class="md-nav__link">
    3.1 Event dependencies
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-command-queue-barriers" class="md-nav__link">
    3.2 Command queue barriers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-user-events" class="md-nav__link">
    3.3 User events
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../profiling/" class="md-nav__link">
        Profiling OpenCL code in Focal
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../errors/" class="md-nav__link">
        Errors
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../advanced/" class="md-nav__link">
        Advanced topics
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        About
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="About" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          About
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../about/" class="md-nav__link">
        About
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://lkedward.github.io/focal" class="md-nav__link">
        API Reference >
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-event-objects" class="md-nav__link">
    1. Event objects
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-host-synchronisation" class="md-nav__link">
    2. Host synchronisation
  </a>
  
    <nav class="md-nav" aria-label="2. Host synchronisation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-waiting-for-events" class="md-nav__link">
    2.1 Waiting for events
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-dependencies-and-barriers" class="md-nav__link">
    3. Dependencies and barriers
  </a>
  
    <nav class="md-nav" aria-label="3. Dependencies and barriers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-event-dependencies" class="md-nav__link">
    3.1 Event dependencies
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-command-queue-barriers" class="md-nav__link">
    3.2 Command queue barriers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-user-events" class="md-nav__link">
    3.3 User events
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="events-and-synchronisation">Events and synchronisation</h1>
<p>Most OpenCL commands involve enqueueing an operation to a command queue and returning control back to the host program.
If an in-order command queue is used then these operations are guaranteed to be executed in the order that they were submitted.</p>
<p>Implicit host-device synchronisations can occur if blocking data transfers are used (see <a href="../memory/#3-data-transfer-between-device-and-host">host-device transfers</a>).
To explicitly keep track of enqueued operations on the host, we can use event objects issued with each command.</p>
<p>If an out-of-order command queue is used, then additional consideration must be made for inter-dependencies between the operations enqueued;
this is enabled by command queue barriers and dependencies.</p>
<h2 id="1-event-objects">1. Event objects</h2>
<p>Event objects represent operations that have been submitted to a command queue and provide a way of keeping track and specifying dependencies.</p>
<p>The following event objects are made available following certain enqueing operations:</p>
<table>
<thead>
<tr>
<th>Action</th>
<th>Event Object</th>
<th>Action Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>Transfer host array to device buffer</td>
<td><code>fclLastWriteEvent</code>,<br><code>cmdq%lastWriteEvent</code></td>
<td><code>deviceArray = hostArray</code></td>
</tr>
<tr>
<td>Transfer device buffer to host array</td>
<td><code>fclLastReadEvent</code><br><code>cmdq%lastReadEvent</code></td>
<td><code>hostArray = deviceArray</code></td>
</tr>
<tr>
<td>Copy device buffer to device buffer</td>
<td><code>fclLastCopyEvent</code><br><code>cmdq%lastCopyEvent</code></td>
<td><code>deviceArray2 = deviceArray1</code></td>
</tr>
<tr>
<td>Launch kernel</td>
<td><code>fclLastKernelEvent</code><br><code>cmdq%lastKernelEvent</code></td>
<td><code>myKernel%launch()</code></td>
</tr>
<tr>
<td>Enqueue queue barrier</td>
<td><code>fclLastBarrierEvent</code><br><code>cmdq%lastBarrierEvent</code></td>
<td><code>call fclBarrier(...)</code></td>
</tr>
</tbody>
</table>
<p><strong>API ref:</strong>
<a href="https://lkedward.github.io/focal/type/fclcommandq.html">fclCommandQ</a>,
<a href="https://lkedward.github.io/focal/module/focal.html#variable-fcllastwriteevent">fclLastWriteEvent, fclLastReadEvent, fclLastCopyEvent, fclLastKernelEvent, fclLastBarrierEvent</a></p>
<h2 id="2-host-synchronisation">2. Host synchronisation</h2>
<h3 id="21-waiting-for-events">2.1 Waiting for events</h3>
<p>To wait on the host for device events to complete, use the <code>fclWait</code> command.
This command has multiple interfaces defined below.</p>
<p><strong>Interfaces</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">call </span><span class="n">fclWait</span><span class="p">()</span>
<span class="k">call </span><span class="n">fclWait</span><span class="p">(</span><span class="o">&lt;</span><span class="n">fclCommandQ</span><span class="o">&gt;</span><span class="p">)</span>
<span class="k">call </span><span class="n">fclWait</span><span class="p">(</span><span class="o">&lt;</span><span class="n">fclEvent</span><span class="o">&gt;</span><span class="p">)</span>
<span class="k">call </span><span class="n">fclWait</span><span class="p">(</span><span class="o">&lt;</span><span class="n">fclEvent</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">&gt;</span><span class="p">)</span>
</code></pre></div>
<p>When called without any arguments <code>fclWait</code> will wait for all events on the <strong>default command queue</strong> to finish.</p>
<p>Alternatively, a specific command queue may be specified by passing it as an argument to <code>fclWait</code>.</p>
<p>To wait for a specific event to finish, pass that event to <code>fclWait</code>.</p>
<p>Alternatively, to wait for multiple events to complete, pass an array of <code>fclEvent</code> objects to <code>fclWait</code>.</p>
<p><strong>Example:</strong>
Wait on a specific command queue.</p>
<div class="highlight"><pre><span></span><code><span class="k">type</span><span class="p">(</span><span class="n">fclCommandQ</span><span class="p">)</span> <span class="kd">::</span> <span class="n">myCommandQ</span>
<span class="p">...</span>
<span class="k">call </span><span class="n">fclWait</span><span class="p">(</span><span class="n">myCommandQ</span><span class="p">)</span>
</code></pre></div>
<p><strong>Example:</strong>
Wait for a kernel event to complete.</p>
<div class="highlight"><pre><span></span><code><span class="k">type</span><span class="p">(</span><span class="n">fclKernel</span><span class="p">)</span> <span class="kd">::</span> <span class="n">myKernel</span>
<span class="k">type</span><span class="p">(</span><span class="n">fclEvent</span><span class="p">)</span> <span class="kd">::</span> <span class="n">e</span>
<span class="p">...</span>
<span class="n">myKernel</span><span class="p">%</span><span class="n">launch</span><span class="p">()</span>          <span class="c">! Launch kernel</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">fclLastKernelEvent</span>     <span class="c">! Save kernel event object</span>
<span class="p">...</span>                        <span class="c">! Perform other operations</span>
<span class="k">call </span><span class="n">fclWait</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>            <span class="c">! Now wait for kernel to complete</span>
</code></pre></div>
<p><strong>Example:</strong>
Enqueue multiple asynchronous data transfers.</p>
<div class="highlight"><pre><span></span><code><span class="k">type</span><span class="p">(</span><span class="n">fclCommandQ</span><span class="p">)</span> <span class="kd">::</span> <span class="n">cmdq</span>
<span class="k">type</span><span class="p">(</span><span class="n">fclDeviceFloat</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span>
<span class="k">type</span><span class="p">(</span><span class="n">fclEvent</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="kd">::</span> <span class="n">e</span>
<span class="p">...</span>
<span class="n">cmdq</span><span class="p">%</span><span class="n">blockingWrite</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>   <span class="c">! Enable asynchronous host-to-device transfers</span>
<span class="p">...</span>                             
<span class="n">a1</span> <span class="o">=</span> <span class="n">hostArray1</span>                <span class="c">! Enqueue first transfer</span>
<span class="n">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">cmdq</span><span class="p">%</span><span class="n">lastWriteEvent</span>     <span class="c">! Save first transfer event</span>
<span class="n">a2</span> <span class="o">=</span> <span class="n">hostArray2</span>                <span class="c">! Enqueue second transfer</span>
<span class="n">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">cmdq</span><span class="p">%</span><span class="n">lastWriteEvent</span>     <span class="c">! Save second transfer event</span>
<span class="n">a3</span> <span class="o">=</span> <span class="n">hostArray3</span>                <span class="c">! Enqueue third transfer</span>
<span class="n">e</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">cmdq</span><span class="p">%</span><span class="n">lastWriteEvent</span>     <span class="c">! Save third transfer event</span>
<span class="p">...</span>                            <span class="c">! Perform other operations</span>
<span class="k">call </span><span class="n">fclWait</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>                <span class="c">! Now wait for transfers to complete</span>
</code></pre></div>
<p><strong>API ref:</strong>
<a href="https://lkedward.github.io/focal/interface/fclwait.html">fclWait</a></p>
<h2 id="3-dependencies-and-barriers">3. Dependencies and barriers</h2>
<p>If using a single command queue with out-of-order execution disabled, then commands are guaranteed to be executed in the order that they were enqueued.
When using multiple command queues to submit work, or when using command queues with out-of-order execution enabled, then explicit management of dependencies is required
to ensure that work is performed in the correct order; two useful mechanisms are available for this: barriers and event dependencies.</p>
<h3 id="31-event-dependencies">3.1 Event dependencies</h3>
<p>Event dependencies are set prior to enqueueing an operation to specify operations that must first complete for the following operation to start.
The Focal command <code>fclSetDependency</code> is used to specify dependencies for the next enqueued operation.</p>
<p><strong>Example:</strong>
A kernel event depends on previous data transfers</p>
<div class="highlight"><pre><span></span><code><span class="k">type</span><span class="p">(</span><span class="n">fclDeviceFloat</span><span class="p">)</span> <span class="kd">::</span> <span class="n">deviceArray1</span><span class="p">,</span> <span class="n">deviceArray2</span>
<span class="k">type</span><span class="p">(</span><span class="n">fclKernel</span><span class="p">)</span> <span class="kd">::</span> <span class="n">myKernel1</span><span class="p">,</span> <span class="n">myKernel2</span>
<span class="k">type</span><span class="p">(</span><span class="n">fclEvent</span><span class="p">)</span> <span class="kd">::</span> <span class="n">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="k">type</span><span class="p">(</span><span class="n">fclCommandQ</span><span class="p">)</span> <span class="kd">::</span> <span class="n">cmdq2</span>
<span class="p">...</span>
<span class="k">call </span><span class="n">fclSetDefaultCommandQ</span><span class="p">(</span> <span class="n">fclCreateCommandQ</span><span class="p">(</span><span class="n">devices</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">blockingWrite</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.)</span> <span class="p">)</span>
<span class="n">cmdq2</span> <span class="o">=</span> <span class="n">fclCreateCommandQ</span><span class="p">(</span><span class="n">devices</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="n">deviceArray1</span> <span class="o">=</span> <span class="n">hostArray</span>
<span class="n">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">fclLastWriteEvent</span>         <span class="c">! Save first write event</span>
<span class="n">deviceArray2</span> <span class="o">=</span> <span class="n">hostArray</span>
<span class="n">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">fclLastWriteEvent</span>         <span class="c">! Save second write event</span>
<span class="p">...</span>
<span class="c">! Launch kernel with no dependencies on separate cmdq</span>
<span class="n">myKernel1</span><span class="p">%</span><span class="n">launch</span><span class="p">(</span><span class="n">cmdq2</span><span class="p">)</span>
<span class="p">...</span>
<span class="c">! Launch kernel with dependency on events in e</span>
<span class="k">call </span><span class="n">fclSetDependency</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>         
<span class="n">myKernel2</span><span class="p">%</span><span class="n">launch</span><span class="p">(</span><span class="n">deviceArray1</span><span class="p">,</span> <span class="n">deviceArray2</span><span class="p">)</span>
</code></pre></div>
<p>In this example several host-to-device transfers are enqueued followed immediately by an independent kernel execution;
this first kernel can theoretically be executed at the same time as the transfers are occuring.
A second kernel is enqueued with explicit dependencies on the previous transfers; this kernel won't execute until
the transfers are complete.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Unless <code>hold=.true.</code> is specified in <code>fclSetDependency</code> then, dependencies are cleared after each enqueued operations.
<em>i.e.</em> event dependencies will only apply to the next enqueued operation
  not to subsequent ones. See example below for multiple events sharing the same dependency.</p>
</div>
<p><strong>Example:</strong>
Apply the same event dependencies to multiple subsequent commands</p>
<div class="highlight"><pre><span></span><code><span class="k">type</span><span class="p">(</span><span class="n">fclKernel</span><span class="p">)</span> <span class="kd">::</span> <span class="n">myKernel</span>
<span class="k">type</span><span class="p">(</span><span class="n">fclEvent</span><span class="p">)</span> <span class="kd">::</span> <span class="n">e</span>
<span class="p">...</span>
<span class="n">myKernel</span><span class="p">%</span><span class="n">launch</span><span class="p">()</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">fclLastKernelEvent</span>
<span class="p">...</span>
<span class="k">call </span><span class="n">fclSetDependency</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">hold</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.)</span> <span class="c">! Data transfers all depend on previous kernel launch</span>
<span class="n">hostData1</span> <span class="o">=</span> <span class="n">deviceData1</span>
<span class="n">hostData2</span> <span class="o">=</span> <span class="n">deviceData2</span>
<span class="n">hostData3</span> <span class="o">=</span> <span class="n">deviceData3</span>
<span class="k">call </span><span class="n">fclClearDependencies</span><span class="p">()</span>          <span class="c">! Clear held dependencies</span>
</code></pre></div>
<p><strong>API ref:</strong>
<a href="https://lkedward.github.io/focal/interface/fclsetdependency.html">fclSetDependency</a>,
<a href="https://lkedward.github.io/focal/interface/fclcleardependencies.html">fclClearDependencies</a></p>
<h3 id="32-command-queue-barriers">3.2 Command queue barriers</h3>
<p>OpenCL barriers break up the command queue into regions between which there can be no re-ordering of operations.
If a series of operations (group A) is followed by a barrier then followed by another series of operations (group A), then all events from group a must be complete (in any order) before any event in group B can start.</p>
<p>To enqueue a barrier in Focal, use <code>fclBarrier</code>:</p>
<p><strong>Interfaces</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">call </span><span class="n">fclBarrier</span><span class="p">()</span>
<span class="k">call </span><span class="n">fclBarrier</span><span class="p">(</span><span class="o">&lt;</span><span class="n">fclCommandQ</span><span class="o">&gt;</span><span class="p">)</span>
</code></pre></div>
<p>When called with no arguments, this enqueues a barrier onto the <strong>default command queue</strong>.
Otherwise, it enqueues a barrier onto the command queue specified in the first argument.</p>
<p>The barrier can be waiting upon or set as a dependency using the event objects: <code>fclLastBarrierEvent</code> or <code>cmdq%lastBarrierEvent</code>;
this is useful in referencing groups of events.</p>
<p><strong>Example:</strong>
Wait on a group of asynchronous transfers to complete</p>
<div class="highlight"><pre><span></span><code><span class="k">type</span><span class="p">(</span><span class="n">fclCommandQ</span><span class="p">)</span> <span class="kd">::</span> <span class="n">cmdq</span>
<span class="k">type</span><span class="p">(</span><span class="n">fclDeviceFloat</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span>
<span class="p">...</span>
<span class="n">cmdq</span> <span class="o">=</span> <span class="n">fclCreateCommandQ</span><span class="p">(</span><span class="n">devices</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">blockingWrite</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.)</span>
<span class="p">...</span>
<span class="c">! Enqueue asynchronous transfers to device</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">hostA</span>   
<span class="n">b</span> <span class="o">=</span> <span class="n">hostB</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">hostC</span>

<span class="c">! Enqueue barrier</span>
<span class="k">call </span><span class="n">fclBarrier</span><span class="p">(</span><span class="n">cmdq</span><span class="p">)</span>
<span class="p">...</span>
<span class="c">! Wait for all transfers to complete</span>
<span class="k">call </span><span class="n">fclWait</span><span class="p">(</span><span class="n">cmdq</span><span class="p">%</span><span class="n">lastBarrierEvent</span><span class="p">)</span>
<span class="p">...</span>
<span class="c">! OR set a dependency for all transfers to complete</span>
<span class="k">call </span><span class="n">fclSetDependency</span><span class="p">(</span><span class="n">cmdq</span><span class="p">%</span><span class="n">fclLastBarrierEvent</span><span class="p">)</span>
<span class="p">...</span>
</code></pre></div>
<p><strong>API ref:</strong>
<a href="https://lkedward.github.io/focal/interface/fclbarrier.html">fclBarrier</a>,
<a href="https://lkedward.github.io/focal/interface/fclwait.html">fclWait</a>,
<a href="https://lkedward.github.io/focal/interface/fclsetdependency.html">fclSetDependency</a>,
<a href="https://lkedward.github.io/focal/type/fclcommandq.html">fclCommandQ</a>,
<a href="https://lkedward.github.io/focal/module/focal.html#variable-fcllastwriteevent">fclLastBarrierEvent</a></p>
<h3 id="33-user-events">3.3 User events</h3>
<p>OpenCL user events provide a way for device operations to wait for the completion of host operations.
A user event is first created which can be used as a dependency for subsequently enqued device operations.
The host program can then trigger the user event to signal its completion and allow it dependents to start executing.</p>
<p><strong>Example:</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">type</span><span class="p">(</span><span class="n">fclEvent</span><span class="p">)</span> <span class="kd">::</span> <span class="n">myHostEvent</span>
<span class="k">type</span><span class="p">(</span><span class="n">fclKernel</span><span class="p">)</span> <span class="kd">::</span> <span class="n">myKernel</span>
<span class="p">...</span>
<span class="c">! Create user event</span>
<span class="n">myHostEvent</span> <span class="o">=</span> <span class="n">fclCreateUserEvent</span><span class="p">()</span>

<span class="c">! Set dependency on user event</span>
<span class="k">call </span><span class="n">fclSetDependency</span><span class="p">(</span><span class="n">myHostEvent</span><span class="p">)</span>
<span class="k">call </span><span class="n">myKernel</span><span class="p">%</span><span class="n">launch</span><span class="p">()</span>
<span class="p">...</span> <span class="c">! Do some other work</span>

<span class="c">! Trigger user event to signal completion</span>
<span class="k">call </span><span class="n">fclSetUserEvent</span><span class="p">(</span><span class="n">myHostEvent</span><span class="p">)</span>
<span class="c">! Kernel will now run</span>
</code></pre></div>
<p><strong>API ref:</strong>
<a href="https://lkedward.github.io/focal/interface/fclcreateuserevent.html">fclCreateUserEvent</a>,
<a href="https://lkedward.github.io/focal/interface/fclsetuserevent.html">fclSetUserEvent</a></p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../kernels/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Working with kernels" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Working with kernels
            </div>
          </div>
        </a>
      
      
        
        <a href="../profiling/" class="md-footer__link md-footer__link--next" aria-label="Next: Profiling OpenCL code in Focal" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Profiling OpenCL code in Focal
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.477d984a.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.82b56eb2.min.js"></script>
      
    
  </body>
</html>